version: "3.8"

networks:
  arack_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  meilisearch_data:
  qdrant_data:
  stalwart_data:

services:
  # =============================================================================
  # CORE INFRASTRUCTURE
  # =============================================================================

  postgres:
    image: postgres:16
    container_name: arack_postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - arack_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: arack_redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - arack_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  meilisearch:
    image: getmeili/meilisearch:v1.11
    container_name: arack_meilisearch
    environment:
      - MEILI_MASTER_KEY=${MEILISEARCH_KEY}
      - MEILI_ENV=production
      - MEILI_NO_ANALYTICS=true
    volumes:
      - meilisearch_data:/meili_data
    networks:
      - arack_network
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: arack_qdrant
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - arack_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # =============================================================================
  # ORY AUTHENTICATION
  # =============================================================================

  kratos-migrate:
    image: oryd/kratos:v1.3.0
    container_name: arack_kratos_migrate
    environment:
      - DSN=${KRATOS_DATABASE_URL}
    volumes:
      - ./ory/kratos:/etc/config/kratos
    command: migrate sql -e --yes
    networks:
      - arack_network
    depends_on:
      postgres:
        condition: service_healthy

  kratos:
    image: oryd/kratos:v1.3.0
    container_name: arack_kratos
    environment:
      - DSN=${KRATOS_DATABASE_URL}
      - SECRETS_COOKIE=${KRATOS_SECRETS_COOKIE}
      - SECRETS_CIPHER=${KRATOS_SECRETS_CIPHER}
      - SERVE_PUBLIC_BASE_URL=${KRATOS_PUBLIC_URL}/
      - SERVE_ADMIN_BASE_URL=http://kratos:4434/
    volumes:
      - ./ory/kratos:/etc/config/kratos
    command: serve -c /etc/config/kratos/kratos.yml --watch-courier
    restart: unless-stopped
    networks:
      - arack_network
    depends_on:
      - kratos-migrate

  # =============================================================================
  # STALWART MAIL SERVER
  # =============================================================================

  stalwart:
    image: stalwartlabs/stalwart:latest
    container_name: arack_stalwart
    environment:
      - HOSTNAME=mail.arack.io
    volumes:
      - ./ory/stalwart/config.toml:/opt/stalwart/etc/config.toml:ro
      - stalwart_data:/opt/stalwart/data
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - arack_network
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/8080' || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # =============================================================================
  # CENTRIFUGO (Real-time WebSocket)
  # =============================================================================

  centrifugo:
    image: centrifugo/centrifugo:v5
    container_name: arack_centrifugo
    environment:
      - CENTRIFUGO_TOKEN_HMAC_SECRET_KEY=${CENTRIFUGO_TOKEN_HMAC_SECRET}
      - CENTRIFUGO_API_KEY=${CENTRIFUGO_API_KEY}
      - CENTRIFUGO_ADMIN_PASSWORD=admin
      - CENTRIFUGO_ADMIN_SECRET=admin-secret
    volumes:
      - ./centrifugo/config.json:/centrifugo/config.json
    command: centrifugo -c config.json
    restart: unless-stopped
    networks:
      - arack_network

  # =============================================================================
  # APPLICATION SERVICES
  # =============================================================================

  search-service:
    build:
      context: .
      dockerfile: Dockerfile.search
    container_name: arack_search_service
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - MEILISEARCH_URL=${MEILISEARCH_URL}
      - MEILISEARCH_KEY=${MEILISEARCH_KEY}
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - KRATOS_PUBLIC_URL=${KRATOS_PUBLIC_URL}
      - KRATOS_ADMIN_URL=${KRATOS_ADMIN_URL}
      - SERVER_HOST=${SERVER_HOST}
      - SERVER_PORT=${SEARCH_SERVICE_PORT}
      - RUST_LOG=${RUST_LOG}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      meilisearch:
        condition: service_started
      qdrant:
        condition: service_healthy
      kratos:
        condition: service_started
    restart: unless-stopped
    networks:
      - arack_network

  email-service:
    build:
      context: .
      dockerfile: Dockerfile.email
    container_name: arack_email_service
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - MEILISEARCH_URL=${MEILISEARCH_URL}
      - MEILISEARCH_KEY=${MEILISEARCH_KEY}
      - STALWART_URL=${STALWART_URL}
      - STALWART_ADMIN_USER=${STALWART_ADMIN_USER}
      - STALWART_ADMIN_PASSWORD=${STALWART_ADMIN_PASSWORD}
      - KRATOS_PUBLIC_URL=${KRATOS_PUBLIC_URL}
      - KRATOS_ADMIN_URL=${KRATOS_ADMIN_URL}
      - CENTRIFUGO_URL=${CENTRIFUGO_URL}
      - CENTRIFUGO_API_KEY=${CENTRIFUGO_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEFAULT_EMAIL_PASSWORD=${DEFAULT_EMAIL_PASSWORD}
      - SERVER_HOST=${SERVER_HOST}
      - SERVER_PORT=${EMAIL_SERVICE_PORT}
      - RUST_LOG=${RUST_LOG}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      meilisearch:
        condition: service_started
      stalwart:
        condition: service_healthy
      kratos:
        condition: service_started
      centrifugo:
        condition: service_started
    restart: unless-stopped
    networks:
      - arack_network

  # =============================================================================
  # NGINX REVERSE PROXY
  # =============================================================================

  nginx:
    image: nginx:alpine
    container_name: arack_nginx
    ports:
      - "80:80"
      - "443:443"
      - "25:25"       # SMTP
      - "587:587"     # Submission
      - "143:143"     # IMAP
      - "993:993"     # IMAPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    depends_on:
      - search-service
      - email-service
      - kratos
      - stalwart
      - centrifugo
    restart: unless-stopped
    networks:
      - arack_network

  # =============================================================================
  # CERTBOT (SSL Certificates)
  # =============================================================================

  certbot:
    image: certbot/certbot
    container_name: arack_certbot
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - /var/www/certbot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - arack_network
