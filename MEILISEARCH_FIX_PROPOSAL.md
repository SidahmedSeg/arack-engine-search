# Meilisearch Fix Proposal - REVIEW REQUIRED ‚ö†Ô∏è

**Date:** December 23, 2025
**Time:** 14:55 UTC
**Status:** ‚ö†Ô∏è **AWAITING USER APPROVAL**

---

## üî¥ CRITICAL ISSUE

### User-Facing Symptoms
1. ‚ùå **Keyword search fails** - Error: "HTTP request failed: error sending request for url (http://meilisearch:7700/indexes/documents/search)"
2. ‚ùå **Admin dashboard fails** - https://admin.arack.io shows "Request failed with status code 500"
3. ‚ùå **Search service errors** - 500 Internal Server Error responses

### Root Cause
**Meilisearch container is in a CRASH LOOP** due to invalid master key.

**Error:**
```
The master key must be at least 16 bytes in a production environment.
The provided key is only 9 bytes.
```

**Current Configuration:**
- Master key: `masterKey` (9 bytes) ‚ùå
- Required: Minimum 16 bytes
- Meilisearch version: v1.11
- Environment: `MEILI_ENV=production`

**Container Status:**
```
arack_meilisearch   Restarting (1) 56 seconds ago
```

---

## ‚úÖ VERIFICATION: Semantic Search Status

**Qdrant (Vector Search) is HEALTHY:**
- Container status: `Up 20 hours (healthy)`
- Collections loaded: `image_embeddings`, `pages`, `page_embeddings`
- API: Listening on port 6333
- Status: ‚úÖ **WORKING**

**Architecture:**
- **Keyword Search** ‚Üí Meilisearch (BROKEN ‚ùå)
- **Semantic Search** ‚Üí Qdrant (WORKING ‚úÖ)

---

## üîç Current Configuration

### File: `/opt/arack/.env.production`
```bash
# MEILISEARCH CONFIGURATION
MEILISEARCH_URL=http://meilisearch:7700
MEILISEARCH_KEY=masterKey  # ‚Üê ONLY 9 BYTES (INVALID)
```

### File: `/opt/arack/docker-compose.production.yml`
```yaml
meilisearch:
  image: getmeili/meilisearch:v1.11
  container_name: arack_meilisearch
  environment:
    - MEILI_MASTER_KEY=${MEILISEARCH_KEY}  # ‚Üê Uses .env.production value
    - MEILI_ENV=production
    - MEILI_NO_ANALYTICS=true
  volumes:
    - meilisearch_data:/meili_data
  networks:
    - arack_network
  restart: unless-stopped
```

---

## üõ†Ô∏è PROPOSED FIX

### Option 1: Use Meilisearch-Generated Secure Key (RECOMMENDED)

Meilisearch has generated secure keys in the logs. We can use one of these:

**Suggested Key (44 bytes, cryptographically secure):**
```
62Qo5j3PmbJafwxDYRtiSpnmgoDrEJ4UhDIfQUvURJM
```

**Steps:**
1. Update `.env.production`:
   ```bash
   MEILISEARCH_KEY=62Qo5j3PmbJafwxDYRtiSpnmgoDrEJ4UhDIfQUvURJM
   ```

2. Restart Meilisearch container:
   ```bash
   docker-compose -f /opt/arack/docker-compose.production.yml restart meilisearch
   ```

3. Restart search service to use new key:
   ```bash
   docker-compose -f /opt/arack/docker-compose.production.yml restart search-service
   ```

4. Verify Meilisearch is running:
   ```bash
   docker ps | grep meilisearch
   docker logs arack_meilisearch --tail 20
   ```

5. Test search endpoint:
   ```bash
   curl https://api.arack.io/api/search?q=test
   ```

**Pros:**
- ‚úÖ Uses cryptographically secure key generated by Meilisearch
- ‚úÖ 44 bytes (well above 16-byte minimum)
- ‚úÖ Simple 1-line change to `.env.production`
- ‚úÖ Existing Meilisearch data preserved

**Cons:**
- ‚ö†Ô∏è Search service will need new key value (but reads from same .env file)

---

### Option 2: Generate Custom 16+ Byte Key

Generate a custom key with minimum 16 bytes:

**Example:**
```bash
# Generate a 32-character key (16+ bytes)
openssl rand -base64 32 | tr -d "=+/" | cut -c1-32
```

**Result Example:**
```
aB3dEf9hIj2kLmN4pQr6StU8vWx0Yz5C
```

**Pros:**
- ‚úÖ Custom key you control
- ‚úÖ Can make it memorable if needed

**Cons:**
- ‚ö†Ô∏è Extra step to generate key
- ‚ö†Ô∏è Less secure than Meilisearch-generated key

---

### Option 3: Downgrade to Development Mode (NOT RECOMMENDED)

Change `MEILI_ENV=development` to allow short keys.

**Pros:**
- ‚úÖ No key change needed

**Cons:**
- ‚ùå **SECURITY RISK** - Not suitable for production
- ‚ùå Performance degradation
- ‚ùå No analytics disabled by default
- ‚ùå Not following best practices

**Verdict:** ‚ùå **DO NOT USE THIS OPTION**

---

## üìã RECOMMENDED APPROACH (Option 1)

### Step-by-Step Fix

**1. Create Backup of Current Config**
```bash
ssh root@213.199.59.206
cd /opt/arack
cp .env.production .env.production.backup_before_meilisearch_fix_$(date +%Y%m%d_%H%M%S)
```

**2. Update Meilisearch Key**
```bash
# Edit .env.production
nano /opt/arack/.env.production

# Change this line:
# MEILISEARCH_KEY=masterKey

# To this:
# MEILISEARCH_KEY=62Qo5j3PmbJafwxDYRtiSpnmgoDrEJ4UhDIfQUvURJM
```

**3. Restart Services**
```bash
cd /opt/arack
docker-compose -f docker-compose.production.yml restart meilisearch
sleep 10  # Wait for Meilisearch to start
docker-compose -f docker-compose.production.yml restart search-service
```

**4. Verify Meilisearch is Running**
```bash
docker ps | grep meilisearch
# Expected: Up X seconds (healthy)

docker logs arack_meilisearch --tail 20
# Should NOT see "master key must be at least 16 bytes" error
```

**5. Test Search Functionality**
```bash
# From VPS
curl -s http://localhost:3000/api/search?q=test | head -20

# From browser
# Visit: https://api.arack.io/api/search?q=test
# Visit: https://admin.arack.io (should load without 500 errors)
```

---

## ‚ö†Ô∏è IMPORTANT CONSIDERATIONS

### 1. Existing Meilisearch Data
**Question:** Will changing the master key affect existing indexed data?

**Answer:** **NO** - The master key is for API authentication, not data encryption.
- Existing indexed documents will remain intact
- No re-indexing required
- Data stored in Docker volume `meilisearch_data` is independent of master key

### 2. Search Service Configuration
The search service reads `MEILISEARCH_KEY` from the same `.env.production` file via:
```yaml
search-service:
  environment:
    - MEILISEARCH_URL=${MEILISEARCH_URL}
    - MEILISEARCH_KEY=${MEILISEARCH_KEY}  # ‚Üê Reads from .env.production
```

**This means:**
- ‚úÖ Changing `.env.production` updates BOTH Meilisearch AND search service
- ‚úÖ No code changes needed
- ‚úÖ Just restart containers to pick up new env var

### 3. Redis Authentication Errors
Search service logs show:
```
ERROR Failed to dequeue job: NOAUTH: Authentication required.
ERROR Worker worker-xxx error: NOAUTH: Authentication required.
```

**Cause:** Redis may require authentication but search service not providing it.

**Separate Issue:** This is NOT related to Meilisearch crash, but should be investigated after Meilisearch is fixed.

---

## üß™ TESTING PLAN

### After Applying Fix:

**1. Verify Meilisearch Container**
```bash
docker ps | grep meilisearch
# Expected: Up X seconds (healthy), NOT "Restarting"

docker logs arack_meilisearch --tail 50
# Should see: "Actix runtime started"
# Should NOT see: "master key must be at least 16 bytes"
```

**2. Test Meilisearch API**
```bash
# From VPS
curl -H "Authorization: Bearer 62Qo5j3PmbJafwxDYRtiSpnmgoDrEJ4UhDIfQUvURJM" \
  http://localhost:7700/health
# Expected: {"status":"available"}
```

**3. Test Keyword Search**
```bash
# Test search API
curl https://api.arack.io/api/search?q=test
# Expected: JSON response with search results

# Test from frontend
# Visit: https://arack.io
# Search for: "test"
# Expected: Search results displayed
```

**4. Test Admin Dashboard**
```bash
# Visit: https://admin.arack.io
# Expected: Dashboard loads without 500 errors
# Expected: Stats API endpoints working
```

**5. Verify Semantic Search Still Works**
```bash
# Semantic search uses Qdrant (not Meilisearch)
# Should continue working regardless of Meilisearch fix
```

---

## üîí SAFEGUARDS

### Backup Created
- ‚úÖ `.env.production.backup_before_meilisearch_fix_TIMESTAMP`

### Rollback Plan
If the fix causes issues:
```bash
cd /opt/arack
cp .env.production.backup_before_meilisearch_fix_TIMESTAMP .env.production
docker-compose -f docker-compose.production.yml restart meilisearch search-service
```

**Note:** Rolling back will return to the BROKEN state (crash loop). Only use rollback if the NEW key causes unexpected issues.

---

## üìä IMPACT ANALYSIS

### What Will Be Fixed
- ‚úÖ Meilisearch will start successfully (no more crash loop)
- ‚úÖ Keyword search will work
- ‚úÖ Admin dashboard will load
- ‚úÖ Search API will return results instead of 500 errors

### What Will NOT Change
- ‚úÖ Existing indexed data preserved
- ‚úÖ Semantic search (Qdrant) unaffected
- ‚úÖ No code changes required
- ‚úÖ No re-indexing needed

### Services to Restart
1. `arack_meilisearch` - Must restart to pick up new key
2. `arack_search_service` - Must restart to use new key

### Downtime
- **Meilisearch:** ~10 seconds restart time
- **Search Service:** ~5 seconds restart time
- **Total:** ~15 seconds search unavailability

---

## ‚ùì QUESTIONS FOR USER

Before applying this fix, please confirm:

1. **Approve Option 1 (Recommended)?**
   - Use Meilisearch-generated key: `62Qo5j3PmbJafwxDYRtiSpnmgoDrEJ4UhDIfQUvURJM`
   - OR generate custom key?

2. **Preferred Timing?**
   - Apply immediately?
   - OR schedule for specific time?

3. **Redis Authentication Errors**
   - Should I investigate Redis NOAUTH errors AFTER Meilisearch is fixed?
   - This appears to be a separate issue with job queue workers

---

## üìù NEXT STEPS AFTER FIX

### 1. Update Safeguards Documentation
Add Meilisearch master key requirement to:
- `EMAIL_SERVICE_SAFEGUARDS.md` (or create `SEARCH_SERVICE_SAFEGUARDS.md`)
- `CLAUDE.md` RED LINES section

### 2. Monitor for 24 Hours
- Watch Meilisearch container status
- Check search service logs
- Verify user-facing search works
- Monitor admin dashboard

### 3. Investigate Secondary Issues
- Redis NOAUTH errors (job queue workers)
- Any other 500 errors in admin dashboard

---

## üéØ SUCCESS CRITERIA

- ‚úÖ Meilisearch container status: `Up X seconds (healthy)`
- ‚úÖ No "master key must be at least 16 bytes" errors in logs
- ‚úÖ Keyword search returns results
- ‚úÖ Admin dashboard loads without 500 errors
- ‚úÖ Search API endpoints return 200 status codes
- ‚úÖ Existing indexed data intact

---

## ‚ö†Ô∏è AWAITING USER APPROVAL

**This fix requires your approval before implementation.**

Please review and confirm:
- [ ] Approve Option 1 (Meilisearch-generated key)
- [ ] Approve timing for applying fix
- [ ] Confirm understanding of 15-second downtime for search
- [ ] Any concerns or questions?

**Once approved, I will:**
1. Create backup of `.env.production`
2. Update `MEILISEARCH_KEY` to new value
3. Restart Meilisearch and search service containers
4. Verify all success criteria
5. Report results
