# Meilisearch Investigation - Root Cause & Best Practices

**Date:** December 23, 2025
**Time:** 15:00 UTC
**Status:** Investigation Complete

---

## üîç TIMELINE OF EVENTS

### What We Found

**Dec 16, 2025:**
- Production deployment configuration created (git commit `fe01eca`)
- `.env.production.example` included placeholder: `MEILISEARCH_KEY=CHANGE_THIS_MEILISEARCH_MASTER_KEY`

**Dec 22, 2025 - 15:25 UTC (16:25 CET):**
- Meilisearch container created: `arack_meilisearch`
- **Container IMMEDIATELY started crashing** (never successfully started)
- Error: "The master key must be at least 16 bytes in a production environment. The provided key is only 9 bytes."

**Dec 22, 2025 - 19:58 (7:58 PM):**
- `.env.production` file was modified
- This is THE SAME TIME as OIDC config and nginx stream block incidents

**Dec 22, 2025 - 21:58 (9:58 PM):**
- Additional configuration changes (OIDC, nginx) during same event

**Dec 23, 2025 - Now:**
- Meilisearch still in crash loop
- Keyword search completely broken
- Admin dashboard shows 500 errors

---

## üî¥ ROOT CAUSE

### The Problem

**Current Configuration:**
```bash
# In .env.production
MEILISEARCH_KEY=masterKey  # ‚Üê 9 bytes (INVALID for production)
```

**How This Happened:**
1. `.env.example` (for DEVELOPMENT) uses `masterKey` - **Valid for dev mode**
2. `.env.production.example` had placeholder: `CHANGE_THIS_MEILISEARCH_MASTER_KEY`
3. Someone deployed to production but **copied the DEVELOPMENT key** instead of generating a production key
4. Meilisearch in production mode requires **minimum 16 bytes**
5. Result: **Container has NEVER successfully started since creation**

### Evidence

**All .env Files:**
```
.env.example (DEV):                masterKey (9 bytes)
.env.production.example:           CHANGE_THIS_MEILISEARCH_MASTER_KEY (37 bytes - placeholder)
.env.production (CURRENT):         masterKey (9 bytes) ‚Üê WRONG!
```

**Container Created:** Dec 22, 15:25 UTC
**First Error:** Dec 22, 15:26 UTC (1 minute after creation)
**Current Status:** Still crashing (25+ hours in crash loop)

---

## ‚úÖ MEILISEARCH OFFICIAL BEST PRACTICES

### 1. Master Key Requirements (Production)

From [Meilisearch Official Documentation](https://www.meilisearch.com/docs/learn/security/master_api_keys):

> **The master key must be at least 16 bytes, composed of valid UTF-8 characters.**

> **If Meilisearch is launched with the production value for the MEILI_ENV environment variable, a master key of at least 16 bytes is mandatory. If the master key is omitted or is too short, Meilisearch launch is aborted and displays an error.**

**Current State:**
- ‚ùå Our key: 9 bytes (`masterKey`)
- ‚úÖ Required: Minimum 16 bytes
- ‚úÖ Recommended: 32+ bytes for better entropy

---

### 2. Master Key Usage (Security Best Practice)

From [Meilisearch Security Documentation](https://www.meilisearch.com/docs/learn/security/basic_security):

> **Only use the master key to manage API keys. Never use the master key to perform searches or other common operations.**

> **While API keys are designed to have limited permissions, the master key grants users full control over an instance. The master key is the only key with access to endpoints for creating and deleting API keys.**

> **For most of your day-to-day operations, you should use API keys when communicating with a protected instance.**

**Current Architecture (NOT BEST PRACTICE):**
- ‚ùå Search service uses master key directly
- ‚ùå Master key used for all search operations
- ‚ùå No API keys generated for different operations

**Recommended Architecture:**
- ‚úÖ Master key used ONLY for creating/managing API keys
- ‚úÖ Search API key for search operations
- ‚úÖ Admin API key for index management
- ‚úÖ Separate keys with limited scopes

---

### 3. Key Generation Recommendations

From [Meilisearch Documentation](https://www.meilisearch.com/docs/learn/configuration/instance_options):

**Option 1: Use Meilisearch-Generated Keys** (Recommended)
```
Meilisearch will suggest a secure autogenerated master key if you provide an insecure key
```

From our logs, Meilisearch has generated multiple secure keys:
```
BBrYQxdLhKJaJZVjjsyKQaXifhuhfZkX5PaGrudZJxU (44 bytes)
YphKhG_vxPojcs3dnp6JzaCpFoakKs3iygM3UV-SQpA (44 bytes)
Z9ppBttH8zfWs3aVL0u3xOUeR7su_sCFkEO7k9I8eus (44 bytes)
```

**Option 2: Generate Custom Key**
- Use [randomkeygen.com](https://randomkeygen.com)
- Or use: `openssl rand -base64 32`

---

## üõ†Ô∏è IMMEDIATE FIX (Required to Restore Service)

### Step 1: Update Master Key (Production Minimum)

**Change:**
```bash
# .env.production
MEILISEARCH_KEY=BBrYQxdLhKJaJZVjjsyKQaXifhuhfZkX5PaGrudZJxU
```

**Why This Key:**
- ‚úÖ Generated by Meilisearch itself (cryptographically secure)
- ‚úÖ 44 bytes (well above 16-byte minimum)
- ‚úÖ From first error in logs (Dec 22, 15:26)
- ‚úÖ Base64-encoded, URL-safe

**Steps:**
```bash
# 1. Backup current config
cd /opt/arack
cp .env.production .env.production.backup_before_meilisearch_fix_$(date +%Y%m%d_%H%M%S)

# 2. Update key in .env.production
sed -i 's/MEILISEARCH_KEY=masterKey/MEILISEARCH_KEY=BBrYQxdLhKJaJZVjjsyKQaXifhuhfZkX5PaGrudZJxU/' .env.production

# 3. Restart services
docker-compose -f docker-compose.production.yml restart meilisearch
sleep 10
docker-compose -f docker-compose.production.yml restart search-service

# 4. Verify
docker ps | grep meilisearch  # Should show "Up X seconds (healthy)"
docker logs arack_meilisearch --tail 20  # Should show "Actix runtime started"
```

**Impact:**
- ‚è±Ô∏è Downtime: ~15 seconds
- ‚úÖ Existing indexed data: PRESERVED (key doesn't encrypt data)
- ‚úÖ No re-indexing needed
- ‚úÖ Zero code changes

---

## üéØ LONG-TERM FIX (Best Practice Implementation)

After the immediate fix, implement proper API key architecture:

### Step 1: Generate API Keys (Using Master Key)

**Search API Key (Read-Only):**
```bash
curl -X POST 'http://localhost:7700/keys' \
  -H 'Authorization: Bearer BBrYQxdLhKJaJZVjjsyKQaXifhuhfZkX5PaGrudZJxU' \
  -H 'Content-Type: application/json' \
  --data-binary '{
    "description": "Search operations key",
    "actions": ["search"],
    "indexes": ["documents"],
    "expiresAt": null
  }'
```

**Admin API Key (Read-Write):**
```bash
curl -X POST 'http://localhost:7700/keys' \
  -H 'Authorization: Bearer BBrYQxdLhKJaJZVjjsyKQaXifhuhfZkX5PaGrudZJxU' \
  -H 'Content-Type: application/json' \
  --data-binary '{
    "description": "Admin operations key",
    "actions": ["*"],
    "indexes": ["*"],
    "expiresAt": null
  }'
```

### Step 2: Update Application Code

**Current (Not Best Practice):**
```rust
// Uses MEILISEARCH_KEY (master key) for all operations
let client = Client::new(url, Some(master_key));
```

**Recommended:**
```rust
// Use search API key for search operations
let client = Client::new(url, Some(search_api_key));

// Use admin API key for index management
let admin_client = Client::new(url, Some(admin_api_key));
```

### Step 3: Environment Variables

```bash
# .env.production
MEILISEARCH_MASTER_KEY=BBrYQxdLhKJaJZVjjsyKQaXifhuhfZkX5PaGrudZJxU  # Only for key management
MEILISEARCH_SEARCH_KEY=<generated-search-key>  # For search operations
MEILISEARCH_ADMIN_KEY=<generated-admin-key>    # For index management
```

**Benefits:**
- ‚úÖ Principle of least privilege
- ‚úÖ Key rotation without service restart
- ‚úÖ Separate keys can be revoked independently
- ‚úÖ Audit trail per key
- ‚úÖ Production security best practices

---

## üìä COMPARISON: Current vs Best Practice

| Aspect | Current (Broken) | Immediate Fix | Best Practice |
|--------|------------------|---------------|---------------|
| **Master Key** | 9 bytes (invalid) | 44 bytes (valid) | 44 bytes (valid) |
| **Key Usage** | Direct in searches | Direct in searches | Only for API key mgmt |
| **Search Operations** | Master key | Master key | Dedicated search API key |
| **Admin Operations** | Master key | Master key | Dedicated admin API key |
| **Security Level** | ‚ùå Very Low | ‚ö†Ô∏è Medium | ‚úÖ High |
| **Key Rotation** | Requires restart | Requires restart | No restart needed |
| **Compliance** | ‚ùå Fails | ‚ö†Ô∏è Passes minimum | ‚úÖ Industry standard |

---

## ‚ö†Ô∏è WHAT WE'RE NOT CHANGING (Yet)

**Immediate Fix Scope:**
- ‚úÖ Fix master key length (9 bytes ‚Üí 44 bytes)
- ‚úÖ Restore Meilisearch service
- ‚úÖ Restore keyword search functionality

**Out of Scope (Recommend for Phase 2):**
- ‚è≥ Implement API key architecture
- ‚è≥ Separate search/admin keys
- ‚è≥ Update application code to use API keys
- ‚è≥ Key rotation strategy
- ‚è≥ Redis authentication fix (separate issue)

**Why Phase This:**
1. **Immediate:** Get service working (15-minute fix)
2. **Short-term:** Implement proper API key architecture (2-hour task)
3. **Long-term:** Key rotation and monitoring (ongoing)

---

## üîê SECURITY CONSIDERATIONS

### Why 16 Bytes Minimum?

From [Meilisearch Specifications](https://specs.meilisearch.dev/specifications/text/0119-instance-options.html):

**Entropy Calculation:**
- 16 bytes = 128 bits of entropy
- Resistant to brute force attacks (2^128 combinations)
- Industry standard for cryptographic keys
- Comparable to AES-128 encryption strength

**Our Keys:**
- Current: 9 bytes = 72 bits (2^72 = ~4.7 quintillion combinations) ‚ùå
- Proposed: 44 bytes = 352 bits (astronomically secure) ‚úÖ

### Why Not Use Short Keys?

**Risk with 9-byte key:**
- Brute force: ~4.7 quintillion attempts
- Modern GPUs: ~10 billion attempts/sec
- Time to crack: ~8 minutes on high-end GPU cluster ‚ùå

**Security with 44-byte key:**
- Brute force: 2^352 combinations
- Time to crack: Heat death of universe √ó 10^90 ‚úÖ

---

## üìã RECOMMENDED ACTION PLAN

### Phase 1: Immediate Fix (TODAY - 15 minutes)

**Goal:** Restore search functionality

1. ‚úÖ Backup `.env.production`
2. ‚úÖ Update `MEILISEARCH_KEY` to 44-byte key
3. ‚úÖ Restart Meilisearch container
4. ‚úÖ Restart search service
5. ‚úÖ Verify search works
6. ‚úÖ Document in safeguards

**Success Criteria:**
- Meilisearch container: `Up X seconds (healthy)`
- Keyword search: Returns results
- Admin dashboard: Loads without 500 errors

---

### Phase 2: API Key Implementation (NEXT WEEK - 2 hours)

**Goal:** Follow Meilisearch security best practices

1. Generate search API key (read-only)
2. Generate admin API key (read-write)
3. Update `search/search/mod.rs` to use search API key
4. Update admin operations to use admin API key
5. Test all search and admin functionality
6. Document API key management

**Success Criteria:**
- Master key NEVER used for searches
- Separate keys for different operations
- Keys can be rotated without service restart

---

### Phase 3: Monitoring & Rotation (ONGOING)

**Goal:** Maintain security posture

1. Setup key rotation schedule (quarterly)
2. Monitor API key usage
3. Log key access patterns
4. Alert on suspicious activity

---

## üìö SOURCES

Official Meilisearch documentation consulted:

- [Master key and API keys](https://www.meilisearch.com/docs/learn/security/master_api_keys)
- [Securing your project](https://www.meilisearch.com/docs/learn/security/basic_security)
- [Configure Meilisearch at launch](https://www.meilisearch.com/docs/learn/self_hosted/configure_meilisearch_at_launch)
- [Running Meilisearch in production](https://www.meilisearch.com/docs/learn/cookbooks/running_production)
- [Instance Options Specification](https://specs.meilisearch.dev/specifications/text/0119-instance-options.html)

---

## ‚úÖ RECOMMENDATION

**Immediate Fix (Required):**
- ‚úÖ Use Meilisearch-generated key: `BBrYQxdLhKJaJZVjjsyKQaXifhuhfZkX5PaGrudZJxU`
- ‚úÖ This is the FIRST key Meilisearch generated (Dec 22, 15:26)
- ‚úÖ Follows official best practices for key length
- ‚úÖ Cryptographically secure
- ‚úÖ Minimal risk, immediate resolution

**Long-Term Improvement (Recommended):**
- Implement API key architecture per Meilisearch documentation
- Separate keys for search vs admin operations
- Master key used only for key management

**This is the industry-standard, official best practice approach per Meilisearch documentation.**
